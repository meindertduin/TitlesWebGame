@using TitlesWebGame.WebUi.ViewModels
@using TitlesWebGame.WebUi.Services
@using Newtonsoft.Json
@using TitlesWebGame.Domain.Entities
@using TitlesWebGame.Domain.ViewModels
@using TitlesWebGame.WebUi.Models
@inject GameSocketConnectionManager GameSocketConnectionManager
@implements IDisposable;

<div>
    @if (_isVoting)
    {
        var votingRoundInfo = GameViewModel.NextRoundInfo as CompetitiveArtistVotingRoundInfoViewModel;
        <div>
            <div class="row justify-content-center "></div>
            <div class="row justify-content-center">
                @if (votingRoundInfo != null)
                {
                    foreach (var choice in votingRoundInfo.Choices)
                    {
                        var displayName = GameViewModel.SessionPlayers.FirstOrDefault(x => x.ConnectionId == choice)?.DisplayName;
                        var data = _answers.FirstOrDefault(x => x.ConnectionId == choice)?.Data;

                        var dataUrl = String.Empty;
                        if (data != null)
                        {
                            dataUrl = "data:image/jpg;base64," + Convert.ToBase64String(data);
                        }
                        
                        <div class="col-6 artist-option">
                            <div class="text-center font-weight-bold">
                                @displayName
                            </div>
                            <div class="text-center">
                                <img src="@dataUrl" alt="image could not be loaded" class="img-thumbnail">
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
    else
    {
        <div>
            It's reviewing round
        </div>
    }
</div>

@code {
    [CascadingParameter(Name = "GameViewModel")]
    protected GameViewModel GameViewModel { get; set; }

    private int roundTimer = 0;

    private bool _isVoting = false;
    private bool _isReviewing;

    private List<GameRoundAnswer> _answers;
    
    protected override async Task OnInitializedAsync()
    {
        var responseMessage = await GameSocketConnectionManager.GetAnswerWithData(GameViewModel.RoomKey);
        var responseJson = await responseMessage.Content.ReadAsStringAsync();
        _answers = JsonConvert.DeserializeObject<List<GameRoundAnswer>>(responseJson);

        _isVoting = true;

        GameViewModel.PropertyChanged += OnPropertyChangedHandler;

        Console.WriteLine(_answers[0]);
        
        await base.OnInitializedAsync();
    }
    
    public void OnPropertyChangedHandler(object sender, ViewModelPropertyChangedEventArgs e)
    {
        if (GameViewModel.NextRoundInfo is CompetitiveArtistVotingRoundInfoViewModel)
        {
            _isVoting = true;
            StateHasChanged();
        }
        if (GameViewModel.NextRoundInfo is CompetitiveArtistReviewRoundInfoViewModel)
        {
            _isVoting = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        GameViewModel.PropertyChanged -= OnPropertyChangedHandler;
    }
}